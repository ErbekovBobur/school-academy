<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Редактор новостей - GitHub + ImgBB</title>
    <style>
      :root {
        --primary: #24292e;
        --secondary: #f6f8fa;
        --accent: #0366d6;
        --error: #cb2431;
        --success: #28a745;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
        color: #24292e;
        background-color: #f6f8fa;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e1e4e8;
      }

      h1,
      h2,
      h3 {
        color: var(--primary);
      }

      .auth-section {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
        border: 1px solid rgba(27, 31, 35, 0.2);
        transition: all 0.2s;
      }

      .btn-primary {
        background-color: var(--accent);
        color: white;
        border-color: var(--accent);
      }

      .btn-primary:hover {
        background-color: #035fc7;
      }

      .btn-outline {
        background-color: white;
        color: var(--primary);
      }

      .btn-outline:hover {
        background-color: var(--secondary);
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
      }

      input[type="text"],
      textarea,
      input[type="file"],
      select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
        transition: border-color 0.2s;
      }

      input[type="text"]:focus,
      textarea:focus,
      select:focus {
        border-color: var(--accent);
        outline: none;
        box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.3);
      }

      textarea {
        height: 150px;
        resize: vertical;
        font-family: inherit;
      }

      .error {
        color: var(--error);
        font-size: 13px;
        margin-top: 5px;
        display: none;
      }

      .has-error input,
      .has-error textarea,
      .has-error select {
        border-color: var(--error);
      }

      .has-error .error {
        display: block;
      }

      #preview {
        max-width: 100%;
        max-height: 300px;
        margin-top: 10px;
        display: none;
        border-radius: 6px;
        border: 1px solid #e1e4e8;
      }

      .tabs {
        display: flex;
        border-bottom: 1px solid #e1e4e8;
        margin-bottom: 20px;
      }

      .tab {
        padding: 8px 16px;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        border-radius: 6px 6px 0 0;
        margin-right: 5px;
      }

      .tab.active {
        background-color: white;
        border-color: #e1e4e8;
        border-bottom-color: white;
        font-weight: 600;
      }

      .tab-content {
        display: none;
        background-color: white;
        padding: 20px;
        border-radius: 0 6px 6px 6px;
        border: 1px solid #e1e4e8;
        border-top: none;
      }

      .tab-content.active {
        display: block;
      }

      .news-list {
        list-style: none;
        padding: 0;
      }

      .news-item {
        padding: 15px;
        border: 1px solid #e1e4e8;
        border-radius: 6px;
        margin-bottom: 15px;
        background-color: white;
      }

      .news-item h3 {
        margin-top: 0;
        margin-bottom: 10px;
      }

      .news-item img {
        max-width: 200px;
        max-height: 150px;
        border-radius: 4px;
        margin-top: 10px;
      }

      .news-meta {
        font-size: 13px;
        color: #586069;
        margin-bottom: 10px;
      }

      .actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
      }

      .alert-success {
        background-color: #dff0d8;
        color: #3c763d;
        border: 1px solid #d6e9c6;
      }

      .alert-error {
        background-color: #f2dede;
        color: #a94442;
        border: 1px solid #ebccd1;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Редактор новостей</h1>
      <div class="auth-section" id="auth-section">
        <button id="login-btn" class="btn btn-primary">Войти через GitHub</button>
        <div id="user-info" style="display: none">
          <img id="user-avatar" width="32" height="32" style="border-radius: 50%" />
          <span id="username"></span>
          <button id="logout-btn" class="btn btn-outline">Выйти</button>
        </div>
      </div>
    </header>

    <div id="alert" class="alert"></div>

    <div class="tabs">
      <div class="tab active" data-tab="create">Создать новость</div>
      <div class="tab" data-tab="history">История новостей</div>
    </div>

    <div class="tab-content active" id="create-tab">
      <form id="news-form">
        <div class="form-group">
          <label for="repo">Репозиторий:</label>
          <select id="repo" required>
            <option value="">Выберите репозиторий</option>
          </select>
          <div class="error">Пожалуйста, выберите репозиторий</div>
        </div>

        <div class="form-group">
          <label for="branch">Ветка:</label>
          <select id="branch" required disabled>
            <option value="">Сначала выберите репозиторий</option>
          </select>
          <div class="error">Пожалуйста, выберите ветку</div>
        </div>

        <div class="form-group">
          <label for="file-path">Путь к файлу новостей (например, data/news.json):</label>
          <input type="text" id="file-path" required />
          <div class="error">Пожалуйста, укажите путь к файлу</div>
        </div>

        <div class="form-group">
          <label for="title">Заголовок новости:</label>
          <input type="text" id="title" required />
          <div class="error">Пожалуйста, введите заголовок</div>
        </div>

        <div class="form-group">
          <label for="content">Текст новости:</label>
          <textarea id="content" required></textarea>
          <div class="error">Пожалуйста, введите текст новости</div>
        </div>

        <div class="form-group">
          <label for="image">Изображение:</label>
          <input type="file" id="image" accept="image/*" required />
          <img id="preview" alt="Предпросмотр изображения" />
          <div class="error">Пожалуйста, выберите изображение</div>
        </div>

        <div class="form-group">
          <label for="imgbb-key">API-ключ ImgBB (необязательно):</label>
          <input type="text" id="imgbb-key" placeholder="Если нет ключа, будет использован общий" />
        </div>

        <div class="actions">
          <button type="submit" id="submit-btn" class="btn btn-primary">
            <span id="submit-text">Создать новость</span>
          </button>
        </div>
      </form>
    </div>

    <div class="tab-content" id="history-tab">
      <div id="history-loading">Загрузка истории новостей...</div>
      <ul class="news-list" id="news-list"></ul>
    </div>

    <script>
      // Конфигурация

      // Состояние приложения
      const state = {
        token: null,
        user: null,
        repos: [],
        branches: {},
        news: [],
      };

      // DOM элементы
      const elements = {
        loginBtn: document.getElementById("login-btn"),
        logoutBtn: document.getElementById("logout-btn"),
        userInfo: document.getElementById("user-info"),
        userAvatar: document.getElementById("user-avatar"),
        username: document.getElementById("username"),
        alert: document.getElementById("alert"),
        repoSelect: document.getElementById("repo"),
        branchSelect: document.getElementById("branch"),
        filePath: document.getElementById("file-path"),
        title: document.getElementById("title"),
        content: document.getElementById("content"),
        image: document.getElementById("image"),
        preview: document.getElementById("preview"),
        imgbbKey: document.getElementById("imgbb-key"),
        submitBtn: document.getElementById("submit-btn"),
        submitText: document.getElementById("submit-text"),
        newsForm: document.getElementById("news-form"),
        tabs: document.querySelectorAll(".tab"),
        tabContents: document.querySelectorAll(".tab-content"),
        historyTab: document.getElementById("history-tab"),
        newsList: document.getElementById("news-list"),
        historyLoading: document.getElementById("history-loading"),
      };

      // Инициализация приложения
      function init() {
        // Проверяем авторизацию при загрузке
        checkAuth();

        // Настройка обработчиков событий
        setupEventListeners();

        // Показ превью изображения
        elements.image.addEventListener("change", handleImagePreview);

        // Валидация формы
        setupValidation();
      }

      // Проверка авторизации
      function checkAuth() {
        const token = localStorage.getItem("github_token");
        if (token) {
          state.token = token;
          fetchUser();
        }
      }

      // Настройка обработчиков событий
      function setupEventListeners() {
        // Авторизация
        elements.loginBtn.addEventListener("click", () => {
          window.location.href = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&scope=repo`;
        });

        // Выход
        elements.logoutBtn.addEventListener("click", logout);

        // Выбор репозитория
        elements.repoSelect.addEventListener("change", async () => {
          const repo = elements.repoSelect.value;
          if (repo) {
            await fetchBranches(repo);
          } else {
            elements.branchSelect.innerHTML = '<option value="">Сначала выберите репозиторий</option>';
            elements.branchSelect.disabled = true;
          }
        });

        // Переключение вкладок
        elements.tabs.forEach((tab) => {
          tab.addEventListener("click", () => {
            const tabId = tab.getAttribute("data-tab");
            switchTab(tabId);
          });
        });

        // Отправка формы
        elements.newsForm.addEventListener("submit", handleSubmit);
      }

      // Переключение вкладок
      function switchTab(tabId) {
        elements.tabs.forEach((tab) => {
          tab.classList.remove("active");
          if (tab.getAttribute("data-tab") === tabId) {
            tab.classList.add("active");
          }
        });

        elements.tabContents.forEach((content) => {
          content.classList.remove("active");
          if (content.id === `${tabId}-tab`) {
            content.classList.add("active");
          }
        });

        if (tabId === "history" && state.news.length === 0) {
          loadNewsHistory();
        }
      }

      // Обработка превью изображения
      function handleImagePreview(e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            elements.preview.src = event.target.result;
            elements.preview.style.display = "block";
          };
          reader.readAsDataURL(file);
        }
      }

      // Настройка валидации формы
      function setupValidation() {
        const validateFields = ["repo", "branch", "file-path", "title", "content", "image"];

        validateFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          const errorElement = field.parentElement.querySelector(".error");

          field.addEventListener("input", () => {
            if (field.value.trim()) {
              field.parentElement.classList.remove("has-error");
            }
          });

          field.addEventListener("blur", () => {
            if (field.required && !field.value.trim()) {
              field.parentElement.classList.add("has-error");
            }
          });
        });
      }

      // Валидация формы
      function validateForm() {
        let isValid = true;
        const validateFields = ["repo", "branch", "file-path", "title", "content", "image"];

        validateFields.forEach((fieldId) => {
          const field = document.getElementById(fieldId);
          if (field.required && !field.value.trim()) {
            field.parentElement.classList.add("has-error");
            isValid = false;
          }
        });

        return isValid;
      }

      // Обработка отправки формы
      async function handleSubmit(e) {
        e.preventDefault();

        if (!validateForm()) {
          showAlert("Пожалуйста, заполните все обязательные поля", "error");
          return;
        }

        try {
          setLoading(true);

          // Загружаем изображение
          const imageUrl = await uploadImageToImgBB(
            elements.image.files[0],
            elements.imgbbKey.value.trim() || IMGBB_DEFAULT_KEY
          );

          // Формируем объект новости
          const newsItem = {
            id: generateId(),
            title: elements.title.value.trim(),
            date: getCurrentDate(),
            content: elements.content.value.trim(),
            image: imageUrl,
          };

          // Получаем текущие новости
          const currentNews = await fetchCurrentNews();

          // Добавляем новую новость
          const updatedNews = [newsItem, ...currentNews];

          // Обновляем файл на GitHub
          await updateNewsFile(updatedNews);

          // Очищаем форму
          elements.newsForm.reset();
          elements.preview.style.display = "none";

          // Показываем успешное сообщение
          showAlert("Новость успешно добавлена!", "success");

          // Обновляем историю
          state.news = updatedNews;
          renderNewsList();
        } catch (error) {
          console.error("Ошибка:", error);
          showAlert(`Произошла ошибка: ${error.message}`, "error");
        } finally {
          setLoading(false);
        }
      }

      // Установка состояния загрузки
      function setLoading(isLoading) {
        if (isLoading) {
          elements.submitBtn.disabled = true;
          elements.submitText.innerHTML = '<span class="loading"></span> Обработка...';
        } else {
          elements.submitBtn.disabled = false;
          elements.submitText.textContent = "Создать новость";
        }
      }

      // Показ уведомления
      function showAlert(message, type) {
        elements.alert.textContent = message;
        elements.alert.className = `alert alert-${type}`;
        elements.alert.style.display = "block";

        setTimeout(() => {
          elements.alert.style.display = "none";
        }, 5000);
      }

      // Выход из системы
      function logout() {
        localStorage.removeItem("github_token");
        state.token = null;
        state.user = null;
        state.repos = [];

        elements.loginBtn.style.display = "block";
        elements.userInfo.style.display = "none";

        // Очищаем форму
        elements.repoSelect.innerHTML = '<option value="">Выберите репозиторий</option>';
        elements.branchSelect.innerHTML = '<option value="">Сначала выберите репозиторий</option>';
        elements.branchSelect.disabled = true;

        showAlert("Вы успешно вышли из системы", "success");
      }

      // Получение информации о пользователе
      async function fetchUser() {
        try {
          const response = await fetch(`${GITHUB_API_URL}/user`, {
            headers: {
              Authorization: `token ${state.token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Ошибка получения данных пользователя");
          }

          state.user = await response.json();
          renderUserInfo();
          await fetchRepos();
        } catch (error) {
          console.error("Ошибка:", error);
          logout();
          showAlert("Ошибка авторизации. Пожалуйста, войдите снова.", "error");
        }
      }

      // Отображение информации о пользователе
      function renderUserInfo() {
        elements.loginBtn.style.display = "none";
        elements.userInfo.style.display = "flex";
        elements.userAvatar.src = state.user.avatar_url;
        elements.username.textContent = state.user.login;
      }

      // Получение списка репозиториев
      async function fetchRepos() {
        try {
          const response = await fetch(`${GITHUB_API_URL}/user/repos?per_page=100`, {
            headers: {
              Authorization: `token ${state.token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Ошибка получения репозиториев");
          }

          state.repos = await response.json();
          renderRepoSelect();
        } catch (error) {
          console.error("Ошибка:", error);
          showAlert("Не удалось загрузить репозитории", "error");
        }
      }

      // Отображение списка репозиториев
      function renderRepoSelect() {
        elements.repoSelect.innerHTML = '<option value="">Выберите репозиторий</option>';

        state.repos.forEach((repo) => {
          const option = document.createElement("option");
          option.value = repo.full_name;
          option.textContent = repo.name;
          elements.repoSelect.appendChild(option);
        });
      }

      // Получение списка веток
      async function fetchBranches(repo) {
        try {
          const response = await fetch(`${GITHUB_API_URL}/repos/${repo}/branches`, {
            headers: {
              Authorization: `token ${state.token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Ошибка получения веток");
          }

          const branches = await response.json();
          state.branches[repo] = branches;
          renderBranchSelect(repo);
        } catch (error) {
          console.error("Ошибка:", error);
          showAlert("Не удалось загрузить ветки", "error");
        }
      }

      // Отображение списка веток
      function renderBranchSelect(repo) {
        elements.branchSelect.innerHTML = '<option value="">Выберите ветку</option>';

        state.branches[repo].forEach((branch) => {
          const option = document.createElement("option");
          option.value = branch.name;
          option.textContent = branch.name;
          elements.branchSelect.appendChild(option);
        });

        elements.branchSelect.disabled = false;
      }

      // Загрузка текущих новостей
      async function fetchCurrentNews() {
        const repo = elements.repoSelect.value;
        const branch = elements.branchSelect.value;
        const path = elements.filePath.value.trim();

        try {
          const response = await fetch(`${GITHUB_API_URL}/repos/${repo}/contents/${path}?ref=${branch}`, {
            headers: {
              Authorization: `token ${state.token}`,
              Accept: "application/vnd.github.v3.raw",
            },
          });

          if (!response.ok) {
            // Если файла нет, возвращаем пустой массив
            if (response.status === 404) {
              return [];
            }
            throw new Error("Ошибка загрузки новостей");
          }

          return await response.json();
        } catch (error) {
          console.error("Ошибка:", error);
          showAlert("Не удалось загрузить текущие новости", "error");
          return [];
        }
      }

      // Обновление файла новостей
      async function updateNewsFile(news) {
        const repo = elements.repoSelect.value;
        const branch = elements.branchSelect.value;
        const path = elements.filePath.value.trim();

        // Получаем текущий файл (чтобы узнать sha для обновления)
        const fileInfo = await fetch(`${GITHUB_API_URL}/repos/${repo}/contents/${path}?ref=${branch}`, {
          headers: {
            Authorization: `token ${state.token}`,
          },
        }).then((res) => res.json());

        const content = JSON.stringify(news, null, 2);
        const contentBase64 = btoa(unescape(encodeURIComponent(content)));

        const response = await fetch(`${GITHUB_API_URL}/repos/${repo}/contents/${path}`, {
          method: "PUT",
          headers: {
            Authorization: `token ${state.token}`,
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: `Добавлена новость: ${elements.title.value.trim()}`,
            content: contentBase64,
            branch: branch,
            sha: fileInfo.sha,
          }),
        });

        if (!response.ok) {
          throw new Error("Ошибка обновления файла");
        }
      }

      // Загрузка истории новостей
      async function loadNewsHistory() {
        try {
          elements.historyLoading.style.display = "block";
          elements.newsList.innerHTML = "";

          const repo = elements.repoSelect.value;
          const branch = elements.branchSelect.value;
          const path = elements.filePath.value.trim();

          if (!repo || !branch || !path) {
            showAlert("Сначала выберите репозиторий, ветку и путь к файлу", "error");
            switchTab("create");
            return;
          }

          state.news = await fetchCurrentNews();
          renderNewsList();
        } catch (error) {
          console.error("Ошибка:", error);
          showAlert("Не удалось загрузить историю новостей", "error");
        } finally {
          elements.historyLoading.style.display = "none";
        }
      }

      // Отображение списка новостей
      function renderNewsList() {
        elements.newsList.innerHTML = "";

        if (state.news.length === 0) {
          elements.newsList.innerHTML = "<li>Новостей пока нет</li>";
          return;
        }

        state.news.forEach((newsItem) => {
          const li = document.createElement("li");
          li.className = "news-item";
          li.innerHTML = `
                    <h3>${newsItem.title}</h3>
                    <div class="news-meta">Дата: ${newsItem.date} • ID: ${newsItem.id}</div>
                    <p>${newsItem.content}</p>
                    ${newsItem.image ? `<img src="${newsItem.image}" alt="${newsItem.title}">` : ""}
                    <div class="actions">
                        <button class="btn btn-outline edit-btn" data-id="${newsItem.id}">Редактировать</button>
                        <button class="btn btn-outline delete-btn" data-id="${newsItem.id}">Удалить</button>
                    </div>
                `;
          elements.newsList.appendChild(li);
        });

        // Добавляем обработчики для кнопок
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => editNews(btn.getAttribute("data-id")));
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", () => deleteNews(btn.getAttribute("data-id")));
        });
      }

      // Редактирование новости
      function editNews(id) {
        const newsItem = state.news.find((item) => item.id === id);
        if (!newsItem) return;

        // Заполняем форму
        elements.title.value = newsItem.title;
        elements.content.value = newsItem.content;

        // Для изображения нужно новое (или оставить старое)
        elements.preview.src = newsItem.image;
        elements.preview.style.display = "block";

        // TODO: Реализовать полное редактирование с обновлением
        showAlert('Редактирование: замените изображение и нажмите "Создать новость"', "success");
        switchTab("create");
      }

      // Удаление новости
      async function deleteNews(id) {
        if (!confirm("Вы уверены, что хотите удалить эту новость?")) return;

        try {
          const updatedNews = state.news.filter((item) => item.id !== id);
          await updateNewsFile(updatedNews);
          state.news = updatedNews;
          renderNewsList();
          showAlert("Новость успешно удалена", "success");
        } catch (error) {
          console.error("Ошибка:", error);
          showAlert("Не удалось удалить новость", "error");
        }
      }

      // Загрузка изображения на ImgBB
      async function uploadImageToImgBB(file, apiKey) {
        const formData = new FormData();
        formData.append("image", file);

        const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          throw new Error("Ошибка загрузки изображения");
        }

        const data = await response.json();
        return data.data.url;
      }

      // Генерация ID
      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      // Получение текущей даты
      function getCurrentDate() {
        return new Date().toISOString().split("T")[0];
      }

      // Обработка OAuth callback
      function handleOAuthCallback() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get("code");

        if (code) {
          // В реальном приложении здесь должен быть запрос к вашему бэкенду
          // для обмена code на токен (из соображений безопасности)
          // Для демонстрации мы просто сохраняем code как токен
          localStorage.setItem("github_token", code);
          state.token = code;

          // Удаляем code из URL
          window.history.replaceState({}, document.title, window.location.pathname);

          // Загружаем данные пользователя
          fetchUser();
        }
      }

      // Запуск приложения
      handleOAuthCallback();
      init();
    </script>
  </body>
</html>
